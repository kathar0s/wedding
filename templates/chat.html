{% extends "base.html" %}
{% load humanize %}
{% load staticfiles %}
{% load customtags %}
{% block body %}
	<div class="chat-wrapper">
		<div class="title">
			<button class="btn btn-back">
				<i class="fa fa-angle-left"></i>
				한의주 ♡ 형정석
			</button>
			<button class="btn btn-menu pull-right">
				<i class="fa fa-bars"></i>
			</button>
		</div>
		<div class="talk-box">
			<div class="scroller">
			{% for chatlog in chatlogs %}
				{% ifchanged chatlog.created_at|date:"Y-n-j" %}
				<div class="timeline-row">
					<div class="strike">
						<span class="date">{{ chatlog.created_at|date:"Y년 n월 j일 l" }}</span>
					</div>
				</div>
				{% endifchanged %}
				<div class="message-row {{ chatlog.type }}">
					{% if chatlog.type == 'other' %}
					<div class='profile'>
						<img src='{% static "assets/img/profile" %}/{{ chatlog.user.profile }}'>
					</div>
					{% endif %}
					<div class='message-box'>
						<div class='name'>{{ chatlog.user.name }}</div>
						<div class='message'>
							<span class="text">
								{% if chatlog.type == 'me' %}
									{{ chatlog.message }}
								{% else %}
									{{ chatlog.message|safe }}
								{% endif %}
							</span>
							<div class='extra'>
								<div class='badge'>{% if chatlog.unread_count > 0 %}{{ chatlog.unread_count }}{% endif %}</div>
								{% with next_log=chatlogs|next:forloop.counter0 %}
								<div class='date' data-timestamp="{% widthratio chatlog.created_at|date:"U" 1 1000 %}">
									{% if chatlog.created_at|date:"a g:i" != next_log.created_at|date:"a g:i" %}
									{{ chatlog.created_at|date:"a g:i" }}
									{% endif %}
								</div>
								{% endwith %}
							</div>
						</div>
					</div>
				</div>
			{% endfor %}
			</div>
		</div>
		<div class="input-box">
			<button class="btn btn-plus"><i class="fa fa-plus"></i></button>
			<textarea rows="1" id="message"></textarea>
			<button class="btn btn-send" disabled>전송</button>
		</div>
	</div>
	<!-- 사이드 메뉴 영역 -->
	<div class="menu-wrapper">
		<div class="scroller">
			<section>
				<div class="title">
					안내
				</div>
				<hr class="divider"/>
				<div class="content">
					<ul class="list-unstyled">
						{% for article in articles %}
							{% if article.category == 'location' and not user.is_invited %}
							{% else %}
						<li class="media article">
							<div class="media-left">
								<div class="category">
									{% if article.category == 'location' %}
									<i class="fa fa-map-marker"></i>
									{% elif article.category == 'calendar' %}
									<i class="fa fa-calendar"></i>
									{% else %}
									<i class="fa fa-list"></i>
									{% endif %}
								</div>
							</div>
							<div class="media-body">
								<h6 class="title">{{ article.title }}</h6>
								<div class="subscript">
									<strong class="author">{{ article.author }}</strong> · <span class="date">{{ article.created_at|date:"Y년 n월 j일 a g:i" }}</span>
								</div>
							</div>
						</li>
							{% endif %}
						{% empty %}
						<li class="empty">
							아직 게시판에 등록된 글이 없습니다.
						</li>
						{% endfor %}
					</ul>
				</div>
			</section>
			<section>
				<div class="title" href="#">
					<i class="fa fa-angle-right pull-right"></i>
					앨범
				</div>
	{#			<hr class="divider"/>#}
				<div class="content">
					<div class="gallery">
						{% for img in gallery %}
						<div class="img-frame" style="background-image: url('{{ MEDIA_URL }}{{ img.path }}')"></div>
						{% endfor %}
						{% for img in gallery %}
						<div class="img-frame" style="background-image: url('{{ MEDIA_URL }}{{ img.path }}')"></div>
						{% endfor %}
					</div>
				</div>
			</section>
			<section>
				<div class="title">
					신랑 / 신부
				</div>
				<hr class="divider"/>
				<div class="content">
					<ul class="list-unstyled members">
						<li class="media article">
							<div class="media-left">
								<div class="profile">
									<img src="{% static "assets/img/profile/hjs.png" %}">
								</div>
							</div>
							<div class="media-body">
								<div class="name">신랑: 형정석</div>
							</div>
						</li>
						<li class="media article">
							<div class="media-left">
								<div class="profile">
									<img src="{% static "assets/img/profile/hej.png" %}">
								</div>
							</div>
							<div class="media-body">
								<div class="name">신부: 한의주</div>
							</div>
						</li>
					</ul>
				</div>
			</section>
		</div>
		<div class="footer">
			<div class="row">
				<div class="col-xs-3">
					<i class="fa fa-sign-out"></i>
				</div>
				<div class="col-xs-9 share">
					<i class="fa fa-facebook"></i>
					<i class="fa fa-twitter"></i>
				</div>
			</div>
		</div>
	</div>
{% endblock %}
{% block template %}
<div class="message-row" id="tmpl-message">
	<div class='profile'>
		<img src=''>
	</div>
	<div class='message-box'>
		<div class='name'></div>
		<div class='message'>
			<span class="text"></span>
			<div class='extra'>
				<div class='badge'></div>
				<div class='date'></div>
			</div>
		</div>
	</div>
</div>
<div class="timeline-row" id="tmpl-timeline">
	<div class="strike">
		<span class="date"></span>
	</div>
</div>
<div class="notice-row" id="tmpl-notice">
	<span class="message"></span>
	<span class="date"></span>
</div>
{% endblock %}
{% block javascript %}
<script src="{% static "libs/countdown/jquery.countdown.js" %}"></script>
<script>
	var name = '';

	$(document).ready(function(){
		$('#test').on('click', function(e){
			toggleFullScreen();
		});

		resizeChatBox();
		resizeMenuBox();
		centeredText();

		$(window).on('resize', function(e){
			resizeTalkBox();
			resizeChatBox();
			resizeMenuBox();
			centeredText();
		});

		initSideMenu();
		initInputBox();
		resizeTalkBox();

		initChatBox();
	});

	function initChatBox(){
		// 맨 아래로 위치시키기
		var _scroller = $('.talk-box .scroller');
		_scroller.scrollTop(_scroller[0].scrollHeight);

		$('.title .btn-back').on('click', function(e){
			window.history.back();
		});

		$('#message').on('focus blur', function(e){
			setTimeout(function() {
				_scroller.scrollTop(_scroller[0].scrollHeight);
			}, 300);
		});

		{% if chatlogs|length == 0 %}
		$.post(
			'{% url "card:chat_bot" %}',
			{
		        'rcode': 'greeting',
		        'chatroom': '{{ chatroom.id }}',
		        'csrfmiddlewaretoken': '{{ csrf_token }}'
	        },
			function(data) {
				if (!data.error) {
					var messages = data.response.messages;
					showMessage('notice', '<strong>' + messages[0].name + '</strong>님이 <strong>{{ user.name }}</strong>님을 초대했습니다.');
					for (var idx in messages) {
						showMessage('other', messages[idx].message, messages[idx].name, Date.now());
					}
				} else {
					alert(data.message);
				}
			}
		);
		{% endif %}
	}

	function showMessage(type, message, name, timestamp) {
		var template = $('#tmpl-message').clone().removeAttr("id").addClass(type);
		var template_timeline = $('#tmpl-timeline').clone().removeAttr("id");

		var now_time = new Date(timestamp).format("a/p h:mm");
		var now_date = new Date(timestamp).format("yyyy년 M월 d일 E");

		// 마지막 메세지를 가져온다.
		var prev_message = $('.talk-box .scroller .message-row').last();
		var prev_timestamp = prev_message.find('.date').data('timestamp');
		var prev_date = new Date(prev_timestamp).format("yyyy년 M월 d일 E");

		// 이전 메세지의 날짜가 완전 달라지는 경우에는 시간 경계선을 추가한다.
		if (prev_date != now_date) {
			template_timeline.find('.date').text(now_date);
			$('.talk-box .scroller').append(template_timeline);
		}

		if (type == 'notice') {
			template = $('#tmpl-notice').clone().removeAttr("id");

			// 메세지 추가
			template.find('.message').html(message.replace(/\n/g, "<br />"));
		} else {
			var prev_message_date = prev_message.find('.date');

			// 이전 메세지 타입과 현재 시간이 같은 경우에는 이전 메세지의 날짜를 삭제
			if (prev_message.hasClass(type) && prev_message_date.text() == now_time) {
				prev_message_date.text('');
			}

			// 메세지 추가
			template.find('.profile img').attr('src', '{% static "assets/img/profile/hej_hjs.png" %}');
			template.find('.name').text(name);
			template.find('.text').html(message.replace(/\n/g, "<br />"));
			template.find('.badge').text(1);
			template.find('.date').text(now_time);
			template.find('.date').data('timestamp', timestamp);
		}

		$('.talk-box .scroller').append(template);
	}

	function initInputBox() {

		$('#message').on('keyup', function(e){

			var _text = $.trim($(this).val());

			this.style.height = "1px";
			this.style.height = this.scrollHeight+"px";

			resizeChatBox();
			resizeTalkBox();

			if (_text.length > 0) {
				$('.btn-send').removeAttr('disabled');
			} else {
				$('.btn-send').attr('disabled', 'disabled');
			}
		});

		$('#message').on('keydown', function(e){
			if (e.keyCode == 13 && !e.shiftKey) {
				e.preventDefault();

				// 엔터받으면 전송하도록 한다.
				sendMessage();
			}
		});

		$('.btn-send').on('click', function(){
			sendMessage();
		});
	}

	function sendMessage() {
		var _message = $('#message');
		var _scroller = $('.talk-box .scroller');
		var _created_at = Date.now();
		var message = _message.val();
		// 서버에 메세지 저장
		$.post(
			'{% url "card:chat_send" %}',
			{
		        'message': message,
		        'created_at': _created_at,
				'chatroom': '{{ chatroom.id }}',
		        'csrfmiddlewaretoken': '{{ csrf_token }}'
	        },
			function(data) {
				if (!data.error) {
					showMessage('me', message, '{{ user.name }}', _created_at);
					// 맨 아래로 위치시키기
					setTimeout(function() {
						_scroller.scrollTop(_scroller[0].scrollHeight);
					}, 100);
				} else {
					// 에러가 난 경우 메세지 처리
					// 다시 보내기 버튼을 활성화시켜서...
				}
			}
		);

		// 텍스트 상자 초기화
		_message.val('');
		_message.trigger('keyup');

		_message.focus();
	}

	function resizeMenuBox() {
		var width = $(window).width() - 65;
		var right = -(width + 40);

		$('.menu-wrapper').css({'width': width, 'right': right});
	}

	function initSideMenu() {
		$('.btn-menu').on('click', function(e){
			$('.menu-wrapper').addClass('active');
			$('.overlay').addClass('active');
		});

		$('.overlay').on('click', function(e) {
			$('.menu-wrapper').removeClass('active');
			$(this).removeClass('active');
		});
	}

	function centeredText() {
		var _name = $('.splash-wrapper .names');

		var _height = $(window).height();

		_name.css({'bottom': _height * 45 / 100});
	}

	function resizeChatBox(){
		var _message = $('#message');
		var height = _message.outerHeight();
		var width = $(window).outerWidth();

		$('.input-box').height(height);
		$('.btn-plus').outerHeight(height);

		_message.outerWidth(width - 48);

		// 메세지 상자 최대 크기
		$('.message-box .message').css({'max-width': width - 20 - 47 - 85});
	}

	function resizeTalkBox(){
		var height = $(window).height();
		var input_height = $(".chat-wrapper .input-box").outerHeight();
{#		var title_height = $(".chat-wrapper .title").outerHeight();#}

		$('.scroller').height(height - input_height);
	}

	function toggleFullScreen() {
		if (!document.fullscreenElement &&    // alternative standard method
				!document.mozFullScreenElement && !document.webkitFullscreenElement && !document.msFullscreenElement ) {  // current working methods
			if (document.documentElement.requestFullscreen) {
				document.documentElement.requestFullscreen();
			} else if (document.documentElement.msRequestFullscreen) {
				document.documentElement.msRequestFullscreen();
			} else if (document.documentElement.mozRequestFullScreen) {
				document.documentElement.mozRequestFullScreen();
			} else if (document.documentElement.webkitRequestFullscreen) {
				document.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
			}
		} else {
			if (document.exitFullscreen) {
				document.exitFullscreen();
			} else if (document.msExitFullscreen) {
				document.msExitFullscreen();
			} else if (document.mozCancelFullScreen) {
				document.mozCancelFullScreen();
			} else if (document.webkitExitFullscreen) {
				document.webkitExitFullscreen();
			}
		}
	}
</script>
<script type="text/jsx">
	// React Code Goes Here
</script>
{% endblock %}